{% extends 'base.html' %}

{% block content %}
<h1>{% block title %}Welcome to Code Scanning Detective{% endblock %}</h1>
<div class="container" id="accordionExample">  
    {% for key, value in posts.items() %}  
        <div class="card">  
            <div class="card-header" id="heading{{ loop.index }}">  
                <h2 class="mb-0">  
                    <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapse{{ loop.index }}" aria-expanded="true" aria-controls="collapse{{ loop.index }}">  
                        {{ key }}  
                    </button>  
                </h2>  
            </div>  
  
            <div id="collapse{{ loop.index }}" class="collapse" aria-labelledby="heading{{ loop.index }}" data-parent="#accordionExample">  
                <div class="card-body">  
                    <div>Commit SHA: <code>{{ value['sha'] }}</code></div>  
                    <div>Date: <strong>{{ value['date'] }}</strong></div>  
                    {% for vuln in value['vulns'] %}  
                        <div class="post">  
                            <h3>{{ vuln['author'] }}</h3>  
                            <div><a href="mailto:{{ vuln['email'] }}">{{ vuln['email'] }}</a></div>  
                            <div><span class="badge badge-primary">{{ vuln['date'] }}</span></div>  
                            <div>Commit SHA: <code>{{ vuln['sha'] }}</code></div>  
                            <div>File Path: <strong>{{ vuln['file_path'] }}</strong></div>  
                            <div>Line Number: <strong>{{ vuln['line'] }}</strong></div>  
                              
                            <!-- Toggle Button -->  
                            <button class="preview-btn" onclick="togglePreview(this)">Show Preview</button>  
                              
                            <!-- Preview Messages (initially hidden) -->  
                            <ul style="display: none;">  
                                {% for preview_line in vuln['preview'] %}  
                                    <p class="{{ 'highlight' if loop.index0 == vuln['preview_index'] else '' }}">  
                                        {{ preview_line }}  
                                    <p>  
                                {% endfor %}  
                            </ul>  
                              
                            <p>{{ vuln['message'] }}</p>  
                            <hr>  
                        </div>  
                    {% endfor %}  
                </div>  
            </div>  
        </div>  
    {% endfor %}  
</div>  
<script>  
    function togglePreview(button) {  
        var previewUl = button.nextElementSibling;  // Assumes <ul> is right after the button  
        if (previewUl.style.display === "none") {  
            previewUl.style.display = "block";  
            button.textContent = "Hide Preview";  // Change button text  
        } else {  
            previewUl.style.display = "none";  
            button.textContent = "Show Preview";  // Change button text  
        }  
    }  
</script>  

{% endblock %}
